<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•è¯æŠ„å†™PDFç”Ÿæˆå™¨ - å¢å¼ºç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Helvetica Neue', 'Arial', 'sans-serif';
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <div class="bg-white rounded-2xl shadow-lg p-6 md:p-8">
            
            <header class="mb-8 text-center">
                <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">å•è¯æŠ„å†™PDFç”Ÿæˆå™¨</h1>
                <p class="mt-2 text-gray-600">è½»æ¾åˆ›å»ºè‡ªå®šä¹‰çš„è‹±è¯­å•è¯æçº¢ç»ƒä¹ å†Œ - å¢å¼ºç‰ˆ</p>
                
                <!-- ç®¡ç†åŠŸèƒ½æŒ‰é’® -->
                <div class="mt-4 flex flex-wrap justify-center gap-2">
                    <button id="manage-wordbanks-btn" class="bg-green-100 hover:bg-green-200 text-green-800 px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                        ğŸ“š å­—åº“ç®¡ç†
                    </button>
                    <button id="manage-fonts-btn" class="bg-blue-100 hover:bg-blue-200 text-blue-800 px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                        ğŸ”¤ å­—ä½“ç®¡ç†
                    </button>
                    <button id="manage-print-btn" class="bg-purple-100 hover:bg-purple-200 text-purple-800 px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                        ğŸ–¨ï¸ æ‰“å°è®¾ç½®
                    </button>
                </div>
            </header>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                
                <!-- å·¦ä¾§ï¼šè®¾ç½®åŒºåŸŸ -->
                <div class="space-y-6">
                    <div>
                        <label for="word-source" class="block text-sm font-medium text-gray-700 mb-2">1. é€‰æ‹©æˆ–è¾“å…¥è¯åº“</label>
                        <div class="flex gap-2">
                            <select id="word-source" class="flex-1 bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                                <option value="custom">æ‰‹åŠ¨è¾“å…¥è¯åº“</option>
                                <option value="ket">KET æ ¸å¿ƒè¯æ±‡ (ç¤ºä¾‹)</option>
                                <option value="toefl">TOEFL é«˜é¢‘è¯æ±‡ (ç¤ºä¾‹)</option>
                                <option value="gre">GRE é«˜é¢‘è¯æ±‡ (ç¤ºä¾‹)</option>
                            </select>
                            <button id="add-wordbank-btn" class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-lg text-sm font-medium">
                                â•
                            </button>
                            <button id="delete-wordbank-btn" class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded-lg text-sm font-medium" disabled>
                                ğŸ—‘ï¸
                            </button>
                        </div>
                    </div>

                    <div>
                        <textarea id="word-list" rows="10" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5" placeholder="è¯·åœ¨æ­¤å¤„è¾“å…¥å•è¯ï¼Œæ¯è¡Œä¸€ä¸ªå•è¯..."></textarea>
                    </div>

                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">2. è®¾ç½®PDFæ ¼å¼</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label for="repetitions" class="block text-sm font-medium text-gray-700">æçº¢éæ•°</label>
                                <input type="number" id="repetitions" value="5" min="1" max="20" class="mt-1 w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                            </div>
                            <div>
                                <label for="rows-per-page" class="block text-sm font-medium text-gray-700">æ¯é¡µè¡Œæ•°</label>
                                <input type="number" id="rows-per-page" value="10" min="5" max="20" class="mt-1 w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                            </div>
                            <div>
                                <label for="line-spacing" class="block text-sm font-medium text-gray-700">è¡Œé—´è· (pt)</label>
                                <input type="number" id="line-spacing" value="60" min="30" max="80" class="mt-1 w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                            </div>
                            <div>
                                <label for="font-size" class="block text-sm font-medium text-gray-700">å­—ä½“å¤§å° (pt)</label>
                                <input type="number" id="font-size" value="22" min="10" max="30" class="mt-1 w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                            </div>
                            <div>
                                <label for="font-style" class="block text-sm font-medium text-gray-700">å­—ä½“æ ·å¼</label>
                                <div class="flex gap-2">
                                    <select id="font-style" class="flex-1 mt-1 bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                                        <option value="Helvetica">æ ‡å‡†å°åˆ·ä½“ (Print Style)</option>
                                        <option value="Times-Roman">è¡¬çº¿å°åˆ·ä½“ (Serif Print)</option>
                                        <option value="Courier">ç­‰å®½ç»ƒä¹ ä½“ (Monospace)</option>
                                        <option value="cursive-standard">æ ‡å‡†æ‰‹å†™ä½“ (D'Nealian)</option>
                                        <option value="cursive-italic">æ–œä½“æ‰‹å†™ä½“ (Italic Script)</option>
                                        <option value="cursive-zaner">èµçº³-å¸ƒæ´›æ³½ä½“ (Zaner-Bloser)</option>
                                        <option value="cursive-palmer">å¸•å°”é»˜ä½“ (Palmer Method)</option>
                                    </select>
                                    <button id="preview-font-btn" class="mt-1 bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg text-sm font-medium">
                                        ğŸ‘ï¸
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="space-y-2">
                        <button id="preview-pdf-btn" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-4 focus:ring-gray-300 transition-all duration-300 ease-in-out flex items-center justify-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                            é¢„è§ˆPDF
                        </button>
                        <button id="generate-pdf" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:ring-4 focus:ring-blue-300 transition-all duration-300 ease-in-out flex items-center justify-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                            ç”Ÿæˆå¹¶ä¸‹è½½PDF
                        </button>
                    </div>
                </div>

                <!-- å³ä¾§ï¼šé¢„è§ˆå’Œè¯´æ˜ -->
                <div class="bg-gray-50 rounded-lg p-6 flex flex-col items-center justify-center text-center border-2 border-dashed border-gray-300">
                    <div id="loading-indicator" class="hidden flex-col items-center justify-center">
                        <div class="loader"></div>
                        <p class="mt-4 text-gray-600">æ­£åœ¨ç”ŸæˆPDFï¼Œè¯·ç¨å€™...</p>
                    </div>
                    <!-- é¢„è§ˆåŒºåŸŸå·²ç§»é™¤ -->
                    <div id="instructions-area">
                        <svg class="w-24 h-24 text-gray-300 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        <h3 class="mt-4 text-lg font-semibold text-gray-700">ä½¿ç”¨è¯´æ˜</h3>
                        <ol class="text-left text-sm text-gray-600 mt-2 list-decimal list-inside space-y-1">
                            <li>åœ¨å·¦ä¾§é€‰æ‹©æˆ–è¾“å…¥æ‚¨çš„å•è¯åˆ—è¡¨ã€‚</li>
                            <li>æ ¹æ®éœ€è¦è°ƒæ•´æçº¢éæ•°ã€å­—ä½“ç­‰æ ¼å¼ã€‚</li>
                            <li>ç‚¹å‡»â€œç”Ÿæˆå¹¶ä¸‹è½½PDFâ€æŒ‰é’®ã€‚</li>
                            <li>ç¨ç­‰ç‰‡åˆ»ï¼Œæµè§ˆå™¨å°†è‡ªåŠ¨å¼€å§‹ä¸‹è½½æ–‡ä»¶ã€‚</li>
                        </ol>
                         <div class="mt-4 text-xs text-gray-400 border-t pt-4 w-full">
                            <p><strong>V6 æ›´æ–°</strong>: ä¸ºç¡®ä¿ç¨³å®šæ€§ï¼Œå·²ç§»é™¤å­—ä½“é¢„è§ˆåŠŸèƒ½ã€‚</p>
                            <p>æçº¢é¢œè‰²ä¸ºæµ…ç°è‰²ï¼Œæ–¹ä¾¿æ‰“å°ã€‚</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <footer class="text-center mt-6 text-sm text-gray-500">
            <p>ç”± Gemini å¼ºåŠ›é©±åŠ¨ - å¢å¼ºç‰ˆ</p>
        </footer>
    </div>

    <!-- å­—åº“ç®¡ç†æ¨¡æ€æ¡† -->
    <div id="wordbank-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-hidden">
            <div class="p-6 border-b">
                <h3 class="text-lg font-semibold text-gray-900">å­—åº“ç®¡ç†</h3>
            </div>
            <div class="p-6 overflow-y-auto max-h-[60vh]">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">åˆ›å»ºæ–°å­—åº“</label>
                        <input type="text" id="new-wordbank-name" placeholder="å­—åº“åç§°" class="w-full p-2 border border-gray-300 rounded-lg mb-2">
                        <textarea id="new-wordbank-words" rows="4" placeholder="è¾“å…¥å•è¯ï¼Œæ¯è¡Œä¸€ä¸ª..." class="w-full p-2 border border-gray-300 rounded-lg mb-2"></textarea>
                        <button id="save-wordbank-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">ä¿å­˜å­—åº“</button>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ç°æœ‰å­—åº“</label>
                        <div id="wordbank-list" class="space-y-2"></div>
                    </div>
                </div>
            </div>
            <div class="p-6 border-t flex justify-end">
                <button id="close-wordbank-modal" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- å­—ä½“ç®¡ç†æ¨¡æ€æ¡† -->
    <div id="font-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-hidden">
            <div class="p-6 border-b">
                <h3 class="text-lg font-semibold text-gray-900">å­—ä½“ç®¡ç†ä¸é¢„è§ˆ</h3>
            </div>
            <div class="p-6 overflow-y-auto max-h-[60vh]">
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">å­—ä½“é¢„è§ˆ</label>
                        <div class="border border-gray-300 rounded-lg p-4 bg-gray-50">
                            <p id="font-preview-text" class="text-2xl" style="font-family: Helvetica;">The quick brown fox jumps over the lazy dog</p>
                            <p id="font-preview-numbers" class="text-xl mt-2 text-gray-700">0123456789 ABCDEFGHIJKLMNOPQRSTUVWXYZ</p>
                            <p id="font-preview-lowercase" class="text-xl mt-1 text-gray-700">abcdefghijklmnopqrstuvwxyz</p>
                            <p id="font-preview-chinese" class="text-lg mt-2 text-gray-600">å­—ä½“é¢„è§ˆ - é€‚åˆè‹±æ–‡æ‰‹å†™ç»ƒä¹ </p>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ç»ƒä¹ è®¾ç½®</label>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs text-gray-600">æçº¢é¢œè‰²æ·±åº¦</label>
                                <select id="trace-opacity-select" class="w-full p-2 border border-gray-300 rounded-lg">
                                    <option value="100">å¾ˆæµ… (ç»ƒä¹ æ¨¡å¼)</option>
                                    <option value="150">æ ‡å‡†</option>
                                    <option value="180" selected>è¾ƒæ·±</option>
                                    <option value="220">å¾ˆæ·± (æ¼”ç¤ºæ¨¡å¼)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs text-gray-600">çº¿æ¡æ ·å¼</label>
                                <select id="line-style-select" class="w-full p-2 border border-gray-300 rounded-lg">
                                    <option value="standard" selected>æ ‡å‡†å››çº¿æ ¼ï¼ˆè‹±æ–‡æ‰‹å†™æ ‡å‡†ï¼‰</option>
                                    <option value="simple">ç®€å•åŸºçº¿ï¼ˆæœ€å°å¼•å¯¼ï¼‰</option>
                                    <option value="dotted">è™šçº¿å¼•å¯¼ï¼ˆç»ƒä¹ æ¨¡å¼ï¼‰</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">è‡ªå®šä¹‰é¢„è§ˆæ–‡æœ¬</label>
                        <input type="text" id="custom-preview-text" placeholder="è¾“å…¥è¦é¢„è§ˆçš„æ–‡æœ¬..." class="w-full p-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">å­—ä½“è¯´æ˜</label>
                        <div id="font-description" class="p-3 bg-blue-50 rounded-lg text-sm text-gray-700">
                            é€‰æ‹©ä¸€ä¸ªå­—ä½“æŸ¥çœ‹è¯´æ˜...
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-6 border-t flex justify-end gap-2">
                <button id="apply-font-settings" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">åº”ç”¨è®¾ç½®</button>
                <button id="close-font-modal" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- æ‰“å°è®¾ç½®æ¨¡æ€æ¡† -->
    <div id="print-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-hidden">
            <div class="p-6 border-b">
                <h3 class="text-lg font-semibold text-gray-900">æ‰“å°è®¾ç½®</h3>
            </div>
            <div class="p-6 overflow-y-auto max-h-[60vh]">
                <div class="space-y-6">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">çº¸å¼ æ–¹å‘</label>
                            <select id="page-orientation" class="w-full p-2 border border-gray-300 rounded-lg">
                                <option value="portrait">çºµå‘ (Portrait)</option>
                                <option value="landscape">æ¨ªå‘ (Landscape)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">çº¸å¼ å°ºå¯¸</label>
                            <select id="page-size" class="w-full p-2 border border-gray-300 rounded-lg">
                                <option value="a4">A4 (210Ã—297mm)</option>
                                <option value="letter">Letter (216Ã—279mm)</option>
                                <option value="legal">Legal (216Ã—356mm)</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">é¡µè¾¹è·è®¾ç½® (pt)</label>
                        <div class="grid grid-cols-4 gap-2">
                            <div>
                                <label class="block text-xs text-gray-600">ä¸Šè¾¹è·</label>
                                <input type="number" id="margin-top" value="40" min="10" max="100" class="w-full p-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-600">å³è¾¹è·</label>
                                <input type="number" id="margin-right" value="40" min="10" max="100" class="w-full p-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-600">ä¸‹è¾¹è·</label>
                                <input type="number" id="margin-bottom" value="40" min="10" max="100" class="w-full p-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-600">å·¦è¾¹è·</label>
                                <input type="number" id="margin-left" value="40" min="10" max="100" class="w-full p-2 border border-gray-300 rounded-lg">
                            </div>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">é«˜çº§è®¾ç½®</label>
                        <div class="space-y-2">
                            <label class="flex items-center">
                                <input type="checkbox" id="show-page-numbers" class="mr-2">
                                <span class="text-sm">æ˜¾ç¤ºé¡µç </span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="show-header" class="mr-2">
                                <span class="text-sm">æ˜¾ç¤ºé¡µçœ‰</span>
                            </label>
                            <input type="text" id="header-text" placeholder="é¡µçœ‰å†…å®¹..." class="w-full p-2 border border-gray-300 rounded-lg mt-1" disabled>
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-6 border-t flex justify-end gap-2">
                <button id="apply-print-settings" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">åº”ç”¨è®¾ç½®</button>
                <button id="close-print-modal" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- PDFé¢„è§ˆæ¨¡æ€æ¡† -->
    <div id="pdf-preview-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-hidden">
            <div class="p-6 border-b">
                <h3 class="text-lg font-semibold text-gray-900">PDFé¢„è§ˆ</h3>
            </div>
            <div class="p-6 overflow-y-auto max-h-[70vh]">
                <div id="pdf-preview-content" class="border border-gray-300 rounded-lg bg-white min-h-[400px] flex items-center justify-center">
                    <p class="text-gray-500">ç‚¹å‡»é¢„è§ˆæŒ‰é’®ç”Ÿæˆé¢„è§ˆ...</p>
                </div>
            </div>
            <div class="p-6 border-t flex justify-end gap-2">
                <button id="download-from-preview" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">ä¸‹è½½PDF</button>
                <button id="close-pdf-preview" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">å…³é—­</button>
            </div>
        </div>
    </div>

    <script>
        // åº”ç”¨çŠ¶æ€ç®¡ç†
        class WordPrintApp {
            constructor() {
                // æ‰‹å†™å­—ä½“æ˜ å°„å’Œæ ·å¼é…ç½®
                this.fontStyles = {
                    'Helvetica': { 
                        name: 'Helvetica', 
                        type: 'normal',
                        description: 'æ ‡å‡†å°åˆ·ä½“ï¼Œé€‚åˆåˆå­¦è€…',
                        sizeScale: 1.3  // æ ‡å‡†å°åˆ·ä½“æ”¾å¤§30%
                    },
                    'Times-Roman': { 
                        name: 'Times', 
                        type: 'normal',
                        description: 'ä¼ ç»Ÿè¡¬çº¿ä½“ï¼Œæ˜“äºé˜…è¯»',
                        sizeScale: 1.25  // Timeså­—ä½“æ”¾å¤§25%
                    },
                    'Courier': { 
                        name: 'Courier', 
                        type: 'normal',
                        description: 'ç­‰å®½å­—ä½“ï¼Œæ¯ä¸ªå­—æ¯å ç›¸åŒç©ºé—´',
                        sizeScale: 1.35  // Courieréœ€è¦æ›´å¤§çš„ç¼©æ”¾
                    },
                    'cursive-standard': { 
                        name: 'Times', 
                        type: 'italic',
                        letterSpacing: 2,
                        description: 'D\'Nealianæ ‡å‡†æ‰‹å†™ä½“',
                        sizeScale: 1.2  // æ‰‹å†™ä½“ç¨å¾®æ”¾å¤§20%
                    },
                    'cursive-italic': { 
                        name: 'Helvetica', 
                        type: 'oblique',
                        letterSpacing: 3,
                        description: 'æ–œä½“æ‰‹å†™é£æ ¼',
                        sizeScale: 1.25  // æ–œä½“éœ€è¦25%æ”¾å¤§
                    },
                    'cursive-zaner': { 
                        name: 'Times', 
                        type: 'bolditalic',
                        letterSpacing: 2,
                        description: 'Zaner-Bloserç¾å¼æ‰‹å†™ä½“',
                        sizeScale: 1.15  // ç²—æ–œä½“åªéœ€15%æ”¾å¤§
                    },
                    'cursive-palmer': { 
                        name: 'Courier', 
                        type: 'italic',
                        letterSpacing: 1,
                        description: 'Palmeræ–¹æ³•æ‰‹å†™ä½“',
                        sizeScale: 1.35  // Courieræ–œä½“éœ€è¦æ›´å¤§ç¼©æ”¾
                    }
                };
                
                this.wordBanks = {
                    ket: ["ability", "able", "about", "above", "abroad", "accept", "accident", "achieve", "act", "action", "active", "activity", "actor", "actress", "actually", "add", "address", "adventure", "advertise", "advice", "advise", "aeroplane", "afford", "afraid", "after", "afternoon", "again", "against", "age", "ago", "agree"],
                    toefl: ["abandon", "abrupt", "absorb", "abstract", "absurd", "abundant", "accelerate", "accessible", "acclaim", "accommodate", "accumulate", "accurate", "accustomed", "acquaintance", "acquire", "acute", "adequate", "adjacent", "adjust", "administer", "adolescent", "adverse", "advocate", "aesthetic", "affiliate", "affirm", "affluent"],
                    gre: ["abate", "aberrant", "abeyance", "abscond", "abstemious", "admonish", "adulterate", "aesthetic", "aggregate", "alacrity", "alleviate", "amalgamate", "ambiguous", "ambivalence", "ameliorate", "anachronism", "analogous", "anarchy", "anomalous", "antipathy", "apathy", "appease", "apprise", "approbation", "appropriate", "arduous", "articulate", "ascertain", "ascetic", "assuage", "audacious", "austere"]
                };
                
                this.fontSettings = {
                    family: 'Helvetica',
                    traceOpacity: 180,
                    lineStyle: 'standard'
                };
                
                this.printSettings = {
                    orientation: 'portrait',
                    size: 'a4',
                    margins: { top: 40, right: 40, bottom: 40, left: 40 },
                    showPageNumbers: false,
                    showHeader: false,
                    headerText: ''
                };
                
                this.currentPdfDoc = null;
                this.loadSettings();
                this.initializeEventListeners();
                this.updateWordBankList();
                this.updateUI();
            }

            // æœ¬åœ°å­˜å‚¨ç®¡ç†
            saveSettings() {
                const settings = {
                    customWordBanks: this.getCustomWordBanks(),
                    fontSettings: this.fontSettings,
                    printSettings: this.printSettings
                };
                localStorage.setItem('wordPrintSettings', JSON.stringify(settings));
            }

            loadSettings() {
                const saved = localStorage.getItem('wordPrintSettings');
                if (saved) {
                    const settings = JSON.parse(saved);
                    if (settings.customWordBanks) {
                        Object.assign(this.wordBanks, settings.customWordBanks);
                    }
                    if (settings.fontSettings) {
                        this.fontSettings = { ...this.fontSettings, ...settings.fontSettings };
                    }
                    if (settings.printSettings) {
                        this.printSettings = { ...this.printSettings, ...settings.printSettings };
                    }
                }
            }

            getCustomWordBanks() {
                const custom = {};
                for (const [key, value] of Object.entries(this.wordBanks)) {
                    if (!['ket', 'toefl', 'gre'].includes(key)) {
                        custom[key] = value;
                    }
                }
                return custom;
            }

            // å®‰å…¨çš„äº‹ä»¶ç›‘å¬å™¨ç»‘å®š
            addEventListenerSafe(id, event, handler) {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener(event, handler);
                } else {
                    console.warn(`Element with id '${id}' not found`);
                }
            }

            // äº‹ä»¶ç›‘å¬å™¨åˆå§‹åŒ–
            initializeEventListeners() {
                // ä¸»è¦åŠŸèƒ½
                this.addEventListenerSafe('word-source', 'change', (e) => this.handleWordSourceChange(e));
                this.addEventListenerSafe('generate-pdf', 'click', () => this.handleGeneratePDF());
                this.addEventListenerSafe('preview-pdf-btn', 'click', () => this.handlePreviewPDF());
                
                // å­—åº“ç®¡ç†
                this.addEventListenerSafe('manage-wordbanks-btn', 'click', () => this.showWordBankModal());
                this.addEventListenerSafe('add-wordbank-btn', 'click', () => this.showWordBankModal());
                this.addEventListenerSafe('delete-wordbank-btn', 'click', () => this.deleteSelectedWordBank());
                this.addEventListenerSafe('save-wordbank-btn', 'click', () => this.saveNewWordBank());
                this.addEventListenerSafe('close-wordbank-modal', 'click', () => this.hideModal('wordbank-modal'));
                
                // å­—ä½“ç®¡ç†
                this.addEventListenerSafe('manage-fonts-btn', 'click', () => this.showFontModal());
                this.addEventListenerSafe('preview-font-btn', 'click', () => this.showFontModal());
                this.addEventListenerSafe('custom-preview-text', 'input', () => this.updateFontPreview());
                this.addEventListenerSafe('trace-opacity-select', 'change', () => this.updateTraceSettings());
                this.addEventListenerSafe('line-style-select', 'change', () => this.updateTraceSettings());
                this.addEventListenerSafe('apply-font-settings', 'click', () => this.applyFontSettings());
                this.addEventListenerSafe('close-font-modal', 'click', () => this.hideModal('font-modal'));
                
                // ä¸»é¡µé¢å­—ä½“é€‰æ‹©å™¨å˜åŒ–æ—¶å¤„ç†
                this.addEventListenerSafe('font-style', 'change', () => {
                    this.fontSettings.family = document.getElementById('font-style').value;
                    this.saveSettings();
                    this.updateFontPreview();
                    this.showFontChangeNotification();
                });
                
                // æ‰“å°ç®¡ç†
                this.addEventListenerSafe('manage-print-btn', 'click', () => this.showPrintModal());
                this.addEventListenerSafe('show-header', 'change', (e) => {
                    const headerText = document.getElementById('header-text');
                    if (headerText) headerText.disabled = !e.target.checked;
                });
                this.addEventListenerSafe('apply-print-settings', 'click', () => this.applyPrintSettings());
                this.addEventListenerSafe('close-print-modal', 'click', () => this.hideModal('print-modal'));
                
                // PDFé¢„è§ˆ
                this.addEventListenerSafe('download-from-preview', 'click', () => this.downloadPDFFromPreview());
                this.addEventListenerSafe('close-pdf-preview', 'click', () => this.hideModal('pdf-preview-modal'));
            }

            // æ¨¡æ€æ¡†ç®¡ç†
            showModal(modalId) {
                document.getElementById(modalId).classList.remove('hidden');
            }

            hideModal(modalId) {
                document.getElementById(modalId).classList.add('hidden');
            }

            // å­—åº“ç®¡ç†åŠŸèƒ½
            showWordBankModal() {
                this.updateWordBankList();
                this.showModal('wordbank-modal');
            }

            updateWordBankList() {
                const container = document.getElementById('wordbank-list');
                const select = document.getElementById('word-source');
                
                // æ›´æ–°é€‰æ‹©æ¡†
                const currentValue = select.value;
                select.innerHTML = '<option value="custom">æ‰‹åŠ¨è¾“å…¥è¯åº“</option>';
                
                for (const [key, words] of Object.entries(this.wordBanks)) {
                    const option = document.createElement('option');
                    option.value = key;
                    const isCustom = !['ket', 'toefl', 'gre'].includes(key);
                    const label = isCustom ? `${key} (è‡ªå®šä¹‰, ${words.length}è¯)` : 
                                  key === 'ket' ? 'KET æ ¸å¿ƒè¯æ±‡ (ç¤ºä¾‹)' :
                                  key === 'toefl' ? 'TOEFL é«˜é¢‘è¯æ±‡ (ç¤ºä¾‹)' :
                                  'GRE é«˜é¢‘è¯æ±‡ (ç¤ºä¾‹)';
                    option.textContent = label;
                    select.appendChild(option);
                }
                
                select.value = currentValue;
                
                // æ›´æ–°å­—åº“åˆ—è¡¨
                container.innerHTML = '';
                for (const [key, words] of Object.entries(this.wordBanks)) {
                    const item = document.createElement('div');
                    const isBuiltIn = ['ket', 'toefl', 'gre'].includes(key);
                    item.className = `flex items-center justify-between p-3 border rounded-lg ${isBuiltIn ? 'bg-gray-50' : 'bg-blue-50'}`;
                    item.innerHTML = `
                        <div>
                            <div class="font-medium">${key} ${isBuiltIn ? '(å†…ç½®)' : '(è‡ªå®šä¹‰)'}</div>
                            <div class="text-sm text-gray-600">${words.length} ä¸ªå•è¯</div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="app.editWordBank('${key}')" class="text-blue-600 hover:text-blue-800 text-sm">ç¼–è¾‘</button>
                            ${!isBuiltIn ? `<button onclick="app.deleteWordBank('${key}')" class="text-red-600 hover:text-red-800 text-sm">åˆ é™¤</button>` : ''}
                        </div>
                    `;
                    container.appendChild(item);
                }
                
                this.updateDeleteButton();
            }

            updateDeleteButton() {
                const select = document.getElementById('word-source');
                const deleteBtn = document.getElementById('delete-wordbank-btn');
                const selectedKey = select.value;
                const isCustom = selectedKey !== 'custom' && !['ket', 'toefl', 'gre'].includes(selectedKey);
                deleteBtn.disabled = !isCustom;
                deleteBtn.classList.toggle('opacity-50', !isCustom);
                deleteBtn.classList.toggle('cursor-not-allowed', !isCustom);
            }

            saveNewWordBank() {
                const name = document.getElementById('new-wordbank-name').value.trim();
                const wordsText = document.getElementById('new-wordbank-words').value.trim();
                
                if (!name || !wordsText) {
                    alert('è¯·è¾“å…¥å­—åº“åç§°å’Œå•è¯åˆ—è¡¨');
                    return;
                }
                
                const words = wordsText.split('\n').map(w => w.trim()).filter(w => w);
                if (words.length === 0) {
                    alert('è¯·è¾“å…¥è‡³å°‘ä¸€ä¸ªå•è¯');
                    return;
                }
                
                this.wordBanks[name] = words;
                this.saveSettings();
                this.updateWordBankList();
                
                // æ¸…ç©ºè¾“å…¥
                document.getElementById('new-wordbank-name').value = '';
                document.getElementById('new-wordbank-words').value = '';
                
                alert(`å­—åº“ "${name}" å·²ä¿å­˜ï¼ŒåŒ…å« ${words.length} ä¸ªå•è¯`);
            }

            editWordBank(key) {
                const words = this.wordBanks[key];
                document.getElementById('new-wordbank-name').value = key;
                document.getElementById('new-wordbank-words').value = words.join('\n');
            }

            deleteWordBank(key) {
                if (confirm(`ç¡®å®šè¦åˆ é™¤å­—åº“ "${key}" å—ï¼Ÿ`)) {
                    delete this.wordBanks[key];
                    this.saveSettings();
                    this.updateWordBankList();
                    
                    // å¦‚æœå½“å‰é€‰ä¸­çš„æ˜¯è¢«åˆ é™¤çš„å­—åº“ï¼Œåˆ‡æ¢åˆ°è‡ªå®šä¹‰
                    const select = document.getElementById('word-source');
                    if (select.value === key) {
                        select.value = 'custom';
                        this.handleWordSourceChange({ target: select });
                    }
                }
            }

            deleteSelectedWordBank() {
                const select = document.getElementById('word-source');
                const selectedKey = select.value;
                if (selectedKey !== 'custom' && !['ket', 'toefl', 'gre'].includes(selectedKey)) {
                    this.deleteWordBank(selectedKey);
                }
            }

            // å­—ä½“ç®¡ç†åŠŸèƒ½
            showFontModal() {
                this.updateFontModalSettings();
                this.updateFontPreview();
                this.showModal('font-modal');
            }

            updateFontModalSettings() {
                // åŒæ­¥å­—ä½“é€‰æ‹©å™¨çš„å€¼åˆ°æ¨¡æ€æ¡†
                const fontStyleEl = document.getElementById('font-style');
                const traceOpacityEl = document.getElementById('trace-opacity-select');
                const lineStyleEl = document.getElementById('line-style-select');
                
                if (fontStyleEl) {
                    fontStyleEl.value = this.fontSettings.family;
                }
                if (traceOpacityEl) {
                    traceOpacityEl.value = this.fontSettings.traceOpacity;
                }
                if (lineStyleEl) {
                    lineStyleEl.value = this.fontSettings.lineStyle;
                }
            }

            updateFontPreview() {
                const fontFamily = document.getElementById('font-style').value;
                const customText = document.getElementById('custom-preview-text').value;
                const fontConfig = this.fontStyles[fontFamily] || this.fontStyles['Helvetica'];
                
                // æ›´æ–°å­—ä½“è¯´æ˜
                const descriptionEl = document.getElementById('font-description');
                if (descriptionEl) {
                    descriptionEl.innerHTML = `
                        <strong>${fontConfig.description}</strong><br>
                        ${fontFamily.startsWith('cursive') ? 
                            '<span class="text-xs text-gray-600">ğŸ’¡ æç¤ºï¼šæ‰‹å†™ä½“ä¼šè‡ªåŠ¨æ·»åŠ å­—æ¯é—´è·ï¼Œå­—æ¯å¤§å°å·²ä¼˜åŒ–é€‚é…å››çº¿æ ¼æ ‡å‡†</span>' : 
                            '<span class="text-xs text-gray-600">ğŸ’¡ æç¤ºï¼šå­—æ¯å¤§å°å·²ä¸“é—¨ä¼˜åŒ–ï¼Œç¡®ä¿å°å†™å­—æ¯å……æ»¡ç¬¬äºŒçº¿å’Œç¬¬ä¸‰çº¿ä¹‹é—´</span>'}
                        <br><span class="text-xs text-blue-600">ğŸ“ æ ‡å‡†å››çº¿æ ¼ï¼ˆç­‰é—´è·ï¼‰æ•™å­¦ç³»ç»Ÿï¼š<br>
                        â€¢ ç¬¬1çº¿ Sky Lineï¼ˆå¤©ç©ºçº¿ï¼‰- é«˜å­—æ¯(b,d,f,h,k,l,t)çš„é¡¶éƒ¨<br>
                        â€¢ ç¬¬2çº¿ Dotted Lineï¼ˆè™šçº¿ï¼‰- å°å†™å­—æ¯(a,c,e,m,n,oç­‰)çš„é¡¶éƒ¨<br>
                        â€¢ ç¬¬3çº¿ Grass Lineï¼ˆè‰çº¿ï¼‰- æ‰€æœ‰å­—æ¯éƒ½"å"åœ¨è¿™æ¡çº¿ä¸Š<br>  
                        â€¢ ç¬¬4çº¿ Worm Lineï¼ˆèš¯èš“çº¿ï¼‰- ä¸‹ä¼¸å­—æ¯(g,j,p,q,y)çš„åº•éƒ¨<br>
                        âš¡ å››æ¡çº¿é—´è·å®Œå…¨ç›¸ç­‰ï¼Œåˆ›å»ºä¸‰ä¸ªç­‰é«˜ç©ºé—´</span>
                    `;
                }
                
                // åº”ç”¨å­—ä½“åˆ°æ‰€æœ‰é¢„è§ˆå…ƒç´ 
                const previewText = document.getElementById('font-preview-text');
                const previewNumbers = document.getElementById('font-preview-numbers');
                const previewLowercase = document.getElementById('font-preview-lowercase');
                
                // ä½¿ç”¨å®é™…çš„PDFå­—ä½“è¿›è¡Œé¢„è§ˆ
                const actualFont = fontConfig.name;
                const fontStyle = fontConfig.type === 'italic' || fontConfig.type === 'bolditalic' ? 'italic' : 'normal';
                const fontWeight = fontConfig.type === 'bold' || fontConfig.type === 'bolditalic' ? 'bold' : 'normal';
                
                [previewText, previewNumbers, previewLowercase].forEach(element => {
                    if (element) {
                        element.style.fontFamily = actualFont;
                        element.style.fontWeight = fontWeight;
                        element.style.fontStyle = fontStyle;
                        // æ·»åŠ å­—æ¯é—´è·æ•ˆæœé¢„è§ˆ
                        if (fontConfig.letterSpacing) {
                            element.style.letterSpacing = fontConfig.letterSpacing + 'px';
                        } else {
                            element.style.letterSpacing = 'normal';
                        }
                    }
                });
                
                if (customText.trim()) {
                    previewText.textContent = customText;
                    // éšè—å…¶ä»–é¢„è§ˆå…ƒç´ 
                    previewNumbers.style.display = 'none';
                    previewLowercase.style.display = 'none';
                } else {
                    previewText.textContent = 'The quick brown fox jumps over the lazy dog';
                    // æ˜¾ç¤ºæ‰€æœ‰é¢„è§ˆå…ƒç´ 
                    previewNumbers.style.display = 'block';
                    previewLowercase.style.display = 'block';
                    previewNumbers.textContent = '0123456789 ABCDEFGHIJKLMNOPQRSTUVWXYZ';
                    previewLowercase.textContent = 'abcdefghijklmnopqrstuvwxyz';
                }
            }

            applyFontSettings() {
                const fontStyleEl = document.getElementById('font-style');
                const traceOpacityEl = document.getElementById('trace-opacity-select');
                const lineStyleEl = document.getElementById('line-style-select');
                
                if (fontStyleEl) {
                    this.fontSettings.family = fontStyleEl.value;
                    // åŒæ­¥åˆ°ä¸»é¡µé¢çš„å­—ä½“é€‰æ‹©å™¨
                    fontStyleEl.value = this.fontSettings.family;
                }
                
                if (traceOpacityEl) {
                    this.fontSettings.traceOpacity = parseInt(traceOpacityEl.value);
                }
                
                if (lineStyleEl) {
                    this.fontSettings.lineStyle = lineStyleEl.value;
                }
                
                this.saveSettings();
                this.hideModal('font-modal');
                alert('å­—ä½“å’Œç»ƒä¹ è®¾ç½®å·²åº”ç”¨');
            }

            updateTraceSettings() {
                // å®æ—¶æ›´æ–°æçº¢è®¾ç½®
                const traceOpacityEl = document.getElementById('trace-opacity-select');
                const lineStyleEl = document.getElementById('line-style-select');
                
                if (traceOpacityEl) {
                    this.fontSettings.traceOpacity = parseInt(traceOpacityEl.value);
                }
                if (lineStyleEl) {
                    this.fontSettings.lineStyle = lineStyleEl.value;
                }
            }

            // æ‰“å°ç®¡ç†åŠŸèƒ½
            showPrintModal() {
                this.updatePrintModalSettings();
                this.showModal('print-modal');
            }

            updatePrintModalSettings() {
                document.getElementById('page-orientation').value = this.printSettings.orientation;
                document.getElementById('page-size').value = this.printSettings.size;
                document.getElementById('margin-top').value = this.printSettings.margins.top;
                document.getElementById('margin-right').value = this.printSettings.margins.right;
                document.getElementById('margin-bottom').value = this.printSettings.margins.bottom;
                document.getElementById('margin-left').value = this.printSettings.margins.left;
                document.getElementById('show-page-numbers').checked = this.printSettings.showPageNumbers;
                document.getElementById('show-header').checked = this.printSettings.showHeader;
                document.getElementById('header-text').value = this.printSettings.headerText;
                document.getElementById('header-text').disabled = !this.printSettings.showHeader;
            }

            applyPrintSettings() {
                this.printSettings.orientation = document.getElementById('page-orientation').value;
                this.printSettings.size = document.getElementById('page-size').value;
                this.printSettings.margins.top = parseInt(document.getElementById('margin-top').value);
                this.printSettings.margins.right = parseInt(document.getElementById('margin-right').value);
                this.printSettings.margins.bottom = parseInt(document.getElementById('margin-bottom').value);
                this.printSettings.margins.left = parseInt(document.getElementById('margin-left').value);
                this.printSettings.showPageNumbers = document.getElementById('show-page-numbers').checked;
                this.printSettings.showHeader = document.getElementById('show-header').checked;
                this.printSettings.headerText = document.getElementById('header-text').value;
                this.saveSettings();
                this.hideModal('print-modal');
                alert('æ‰“å°è®¾ç½®å·²åº”ç”¨');
            }

            // ä¸»è¦åŠŸèƒ½
            handleWordSourceChange(event) {
                const selected = event.target.value;
                const textarea = document.getElementById('word-list');
                
                if (selected === 'custom') {
                    textarea.value = '';
                    textarea.placeholder = 'è¯·åœ¨æ­¤å¤„è¾“å…¥å•è¯ï¼Œæ¯è¡Œä¸€ä¸ªå•è¯...';
                } else {
                    textarea.value = this.wordBanks[selected].join('\n');
                }
                
                this.updateDeleteButton();
            }

            handleGeneratePDF() {
                this.showLoading(true);
                setTimeout(() => {
                    try {
                        this.generatePDF(true);
                    } catch (error) {
                        console.error("PDFç”Ÿæˆå¤±è´¥:", error);
                        alert("æŠ±æ­‰ï¼ŒPDFç”Ÿæˆå¤±è´¥ã€‚è¯·æ£€æŸ¥æ§åˆ¶å°è·å–æ›´å¤šä¿¡æ¯ã€‚");
                    } finally {
                        this.showLoading(false);
                    }
                }, 50);
            }

            handlePreviewPDF() {
                try {
                    this.generatePDF(false);
                    this.showModal('pdf-preview-modal');
                } catch (error) {
                    console.error("PDFé¢„è§ˆå¤±è´¥:", error);
                    alert("æŠ±æ­‰ï¼ŒPDFé¢„è§ˆå¤±è´¥ã€‚è¯·æ£€æŸ¥æ§åˆ¶å°è·å–æ›´å¤šä¿¡æ¯ã€‚");
                }
            }

            showLoading(show) {
                const loading = document.getElementById('loading-indicator');
                const instructions = document.getElementById('instructions-area');
                const button = document.getElementById('generate-pdf');
                
                if (show) {
                    loading.classList.remove('hidden');
                    loading.classList.add('flex');
                    instructions.classList.add('hidden');
                    button.disabled = true;
                    button.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    loading.classList.add('hidden');
                    loading.classList.remove('flex');
                    instructions.classList.remove('hidden');
                    button.disabled = false;
                    button.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            }

            generatePDF(download = true) {
                const { jsPDF } = window.jspdf;
                
                // è·å–é¡µé¢è®¾ç½®
                const pageSize = this.printSettings.size === 'a4' ? 'a4' : 
                               this.printSettings.size === 'letter' ? 'letter' : 'legal';
                
                const doc = new jsPDF({ 
                    orientation: this.printSettings.orientation === 'portrait' ? 'p' : 'l', 
                    unit: 'pt', 
                    format: pageSize 
                });

                const words = document.getElementById('word-list').value.split('\n').filter(w => w.trim() !== '');
                if (words.length === 0) {
                    alert("è¯·è¾“å…¥è‡³å°‘ä¸€ä¸ªå•è¯ï¼");
                    return;
                }
                
                const repetitions = parseInt(document.getElementById('repetitions').value);
                const rowsPerPage = parseInt(document.getElementById('rows-per-page').value);
                const lineSpacing = parseInt(document.getElementById('line-spacing').value);
                const fontSize = parseInt(document.getElementById('font-size').value);
                
                // åº”ç”¨å­—ä½“è®¾ç½® - ç¡®ä¿ä½¿ç”¨æœ€æ–°çš„å­—ä½“é€‰æ‹©
                const currentFont = document.getElementById('font-style').value;
                const fontConfig = this.fontStyles[currentFont] || this.fontStyles['Helvetica'];
                
                // è®¾ç½®å­—ä½“
                if (fontConfig.type === 'italic') {
                    doc.setFont(fontConfig.name, 'italic');
                } else if (fontConfig.type === 'bold') {
                    doc.setFont(fontConfig.name, 'bold');
                } else if (fontConfig.type === 'bolditalic') {
                    doc.setFont(fontConfig.name, 'bolditalic');
                } else if (fontConfig.type === 'oblique') {
                    doc.setFont(fontConfig.name, 'italic'); // jsPDFä¸æ”¯æŒobliqueï¼Œç”¨italicä»£æ›¿
                } else {
                    doc.setFont(fontConfig.name, 'normal');
                }

                const pageHeight = doc.internal.pageSize.getHeight();
                const pageWidth = doc.internal.pageSize.getWidth();
                const margins = this.printSettings.margins;
                let y = margins.top;
                let pageNumber = 1;

                // æ·»åŠ é¡µçœ‰
                if (this.printSettings.showHeader && this.printSettings.headerText) {
                    doc.setFontSize(12);
                    doc.text(this.printSettings.headerText, pageWidth / 2, margins.top / 2, { align: 'center' });
                }

                let currentPageRows = 0;  // è·Ÿè¸ªå½“å‰é¡µçš„è¡Œæ•°
                
                for (let i = 0; i < words.length; i++) {
                    const word = words[i];
                    
                    // æ£€æŸ¥æ˜¯å¦éœ€è¦æ–°é¡µé¢ï¼ˆè¶…è¿‡æ¯é¡µè¡Œæ•°é™åˆ¶æˆ–è¶…å‡ºé¡µé¢åº•éƒ¨ï¼‰
                    if (currentPageRows >= rowsPerPage || y > pageHeight - margins.bottom - lineSpacing) {
                        // æ·»åŠ é¡µç 
                        if (this.printSettings.showPageNumbers) {
                            doc.setFontSize(10);
                            doc.text(`ç¬¬ ${pageNumber} é¡µ`, pageWidth - margins.right, pageHeight - margins.bottom / 2, { align: 'right' });
                        }
                        
                        doc.addPage();
                        // é‡æ–°è®¾ç½®å­—ä½“
                        if (fontConfig.type === 'italic') {
                            doc.setFont(fontConfig.name, 'italic');
                        } else if (fontConfig.type === 'bold') {
                            doc.setFont(fontConfig.name, 'bold');
                        } else if (fontConfig.type === 'bolditalic') {
                            doc.setFont(fontConfig.name, 'bolditalic');
                        } else {
                            doc.setFont(fontConfig.name, 'normal');
                        }
                        pageNumber++;
                        y = margins.top;
                        currentPageRows = 0;  // é‡ç½®å½“å‰é¡µè¡Œæ•°è®¡æ•°
                        
                        // æ·»åŠ é¡µçœ‰åˆ°æ–°é¡µé¢
                        if (this.printSettings.showHeader && this.printSettings.headerText) {
                            doc.setFontSize(12);
                            doc.text(this.printSettings.headerText, pageWidth / 2, margins.top / 2, { align: 'center' });
                        }
                    }

                    // æ ‡å‡†è‹±æ–‡å››çº¿æ ¼è®¾è®¡ - ç­‰é«˜é—´è·
                    // å››æ¡çº¿ä¹‹é—´çš„é—´è·å¿…é¡»å®Œå…¨ç›¸ç­‰
                    
                    const lineGap = fontSize * 0.7;    // ç»Ÿä¸€çš„çº¿é—´è·
                    
                    // è®¡ç®—åŸºçº¿ä½ç½®ï¼ˆç¬¬3æ¡çº¿ï¼Œæ‰€æœ‰å­—æ¯éƒ½"å"åœ¨è¿™æ¡çº¿ä¸Šï¼‰
                    const baseLineY = y + lineSpacing * 0.6;
                    
                    // å››çº¿æ ¼ä½ç½®ï¼ˆä»ä¸Šåˆ°ä¸‹ï¼Œç­‰é—´è·ï¼‰
                    const skyLineY = baseLineY - lineGap * 2;       // Sky Lineï¼ˆç¬¬1æ¡çº¿ï¼‰
                    const dottedLineY = baseLineY - lineGap;        // Dotted Middle Lineï¼ˆç¬¬2æ¡çº¿ï¼‰
                    const grassLineY = baseLineY;                   // Baseline/Grass Lineï¼ˆç¬¬3æ¡çº¿ï¼‰
                    const wormLineY = baseLineY + lineGap;          // Descender/Worm Lineï¼ˆç¬¬4æ¡çº¿ï¼‰
                    
                    // éªŒè¯é—´è·ï¼š
                    // Sky Line åˆ° Dotted Line = lineGap
                    // Dotted Line åˆ° Grass Line = lineGap  
                    // Grass Line åˆ° Worm Line = lineGap
                    // ä¸‰ä¸ªé—´è·å®Œå…¨ç›¸ç­‰ï¼

                    // æ ¹æ®çº¿æ¡æ ·å¼è®¾ç½®ç»˜åˆ¶çº¿æ¡
                    doc.setDrawColor(220, 220, 220);
                    doc.setLineWidth(0.7);

                    if (this.fontSettings.lineStyle === 'standard') {
                        // æ ‡å‡†è‹±æ–‡å››çº¿æ ¼ - åŸºäºæ•™å­¦æ ‡å‡†
                        // Sky Line å’Œ Worm Lineï¼ˆå®çº¿ï¼Œè¾ƒç»†ï¼‰
                        doc.setLineWidth(0.5);
                        doc.setDrawColor(200, 200, 200);
                        doc.line(margins.left, skyLineY, pageWidth - margins.right, skyLineY);
                        doc.line(margins.left, wormLineY, pageWidth - margins.right, wormLineY);
                        
                        // Dotted Middle Lineï¼ˆè™šçº¿ï¼Œå°å†™å­—æ¯é¡¶éƒ¨å¼•å¯¼ï¼‰
                        doc.setLineDashPattern([2, 3], 0);
                        doc.setDrawColor(160, 160, 160);
                        doc.line(margins.left, dottedLineY, pageWidth - margins.right, dottedLineY);
                        
                        // Baseline/Grass Lineï¼ˆå®çº¿ï¼Œæœ€ç²—ï¼Œæœ€é‡è¦çš„ä¹¦å†™åŸºå‡†çº¿ï¼‰
                        doc.setLineDashPattern([], 0);
                        doc.setLineWidth(1.0);
                        doc.setDrawColor(100, 100, 100);
                        doc.line(margins.left, grassLineY, pageWidth - margins.right, grassLineY);
                        
                    } else if (this.fontSettings.lineStyle === 'simple') {
                        // ç®€å•åŸºçº¿æ¨¡å¼ï¼ˆåªæœ‰åŸºçº¿ï¼‰
                        doc.setLineWidth(0.8);
                        doc.setDrawColor(150, 150, 150);
                        doc.line(margins.left, grassLineY, pageWidth - margins.right, grassLineY);
                        
                    } else if (this.fontSettings.lineStyle === 'dotted') {
                        // è™šçº¿å¼•å¯¼æ¨¡å¼ï¼ˆå››æ¡çº¿éƒ½æ˜¯è™šçº¿ï¼‰
                        doc.setLineDashPattern([3, 2], 0);
                        doc.setLineWidth(0.6);
                        doc.setDrawColor(180, 180, 180);
                        doc.line(margins.left, skyLineY, pageWidth - margins.right, skyLineY);
                        doc.line(margins.left, dottedLineY, pageWidth - margins.right, dottedLineY);
                        doc.line(margins.left, grassLineY, pageWidth - margins.right, grassLineY);
                        doc.line(margins.left, wormLineY, pageWidth - margins.right, wormLineY);
                        doc.setLineDashPattern([], 0);
                    }

                    const wordY = grassLineY;  // å­—æ¯åº”è¯¥"å"åœ¨åŸºçº¿ï¼ˆè‰çº¿ï¼‰ä¸Š
                    const columnWidth = (pageWidth - margins.left - margins.right) / (repetitions + 1.5);

                    // ç»˜åˆ¶åŸå§‹å•è¯ï¼ˆé»‘è‰²ï¼‰
                    doc.setTextColor(0, 0, 0);
                    // æ ¹æ®ä¸åŒå­—ä½“ç±»å‹è°ƒæ•´å¤§å°ï¼Œè®©å°å†™å­—æ¯ä¸»ä½“å……æ»¡ç¬¬äºŒçº¿å’Œç¬¬ä¸‰çº¿ä¹‹é—´
                    // æ¯ç§å­—ä½“æœ‰è‡ªå·±çš„ç¼©æ”¾æ¯”ä¾‹ä»¥ç¡®ä¿æœ€ä½³è§†è§‰æ•ˆæœ
                    const fontScale = fontConfig.sizeScale || 1.0;  // å¦‚æœæ²¡æœ‰å®šä¹‰ç¼©æ”¾æ¯”ä¾‹ï¼Œé»˜è®¤ä¸ç¼©æ”¾
                    const adjustedFontSize = fontSize * fontScale;
                    doc.setFontSize(adjustedFontSize);
                    
                    // åº”ç”¨å­—æ¯é—´è·ï¼ˆå¦‚æœæ˜¯æ‰‹å†™ä½“ï¼‰
                    if (fontConfig.letterSpacing) {
                        // æ‰‹å†™ä½“éœ€è¦å¢åŠ å­—æ¯é—´è·
                        let xPos = margins.left;
                        for (let char of word) {
                            doc.text(char, xPos, wordY);
                            xPos += doc.getTextWidth(char) + fontConfig.letterSpacing;
                        }
                    } else {
                        doc.text(word, margins.left, wordY);
                    }

                    // ç»˜åˆ¶æçº¢å•è¯ï¼ˆä½¿ç”¨ç”¨æˆ·è®¾ç½®çš„é¢œè‰²æ·±åº¦ï¼‰
                    const opacity = this.fontSettings.traceOpacity || 180;
                    doc.setTextColor(opacity, opacity, opacity);
                    // ç¡®ä¿æçº¢å­—ä½“å¤§å°ä¸åŸå§‹å­—ä½“ä¸€è‡´
                    doc.setFontSize(adjustedFontSize);
                    
                    for (let j = 0; j < repetitions; j++) {
                        const x = margins.left + columnWidth * (j + 1.2);
                        
                        if (fontConfig.letterSpacing) {
                            // æ‰‹å†™ä½“éœ€è¦å¢åŠ å­—æ¯é—´è·
                            let xPos = x;
                            for (let char of word) {
                                doc.text(char, xPos, wordY);
                                xPos += doc.getTextWidth(char) + fontConfig.letterSpacing;
                            }
                        } else {
                            doc.text(word, x, wordY);
                        }
                    }

                    y += lineSpacing;
                    currentPageRows++;  // å¢åŠ å½“å‰é¡µè¡Œæ•°è®¡æ•°
                }

                // æ·»åŠ æœ€åä¸€é¡µçš„é¡µç 
                if (this.printSettings.showPageNumbers) {
                    doc.setFontSize(10);
                    doc.setTextColor(0, 0, 0);
                    doc.text(`ç¬¬ ${pageNumber} é¡µ`, pageWidth - margins.right, pageHeight - margins.bottom / 2, { align: 'right' });
                }

                this.currentPdfDoc = doc;
                
                if (download) {
                    doc.save('å•è¯æŠ„å†™ç»ƒä¹ .pdf');
                } else {
                    // ç”Ÿæˆé¢„è§ˆ
                    const previewContainer = document.getElementById('pdf-preview-content');
                    previewContainer.innerHTML = `
                        <div class="text-center p-8">
                            <div class="mb-4">
                                <svg class="w-16 h-16 text-green-500 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <h4 class="text-lg font-semibold text-gray-900 mb-2">PDFé¢„è§ˆå·²ç”Ÿæˆ</h4>
                            <div class="text-sm text-gray-600 space-y-1">
                                <p>ğŸ“„ æ€»é¡µæ•°: ${pageNumber} é¡µ</p>
                                <p>ğŸ“ å•è¯æ•°é‡: ${words.length} ä¸ª</p>
                                <p>ğŸ”¤ å­—ä½“: ${currentFont}</p>
                                <p>ğŸ“ é¡µé¢: ${pageSize.toUpperCase()} ${this.printSettings.orientation === 'portrait' ? 'çºµå‘' : 'æ¨ªå‘'}</p>
                            </div>
                            <p class="text-xs text-gray-500 mt-4">ç‚¹å‡»"ä¸‹è½½PDF"æŒ‰é’®ä¿å­˜æ–‡ä»¶</p>
                        </div>
                    `;
                }
            }

            downloadPDFFromPreview() {
                if (this.currentPdfDoc) {
                    this.currentPdfDoc.save('å•è¯æŠ„å†™ç»ƒä¹ .pdf');
                    this.hideModal('pdf-preview-modal');
                } else {
                    alert('è¯·å…ˆç”Ÿæˆé¢„è§ˆ');
                }
            }

            updateUI() {
                // æ¢å¤ä¿å­˜çš„å­—ä½“è®¾ç½®åˆ°UI
                document.getElementById('font-style').value = this.fontSettings.family;
                
                // è§¦å‘åˆå§‹åŒ–äº‹ä»¶
                document.getElementById('word-source').dispatchEvent(new Event('change'));
            }

            // æ˜¾ç¤ºå­—ä½“åˆ‡æ¢é€šçŸ¥
            showFontChangeNotification() {
                const notification = document.createElement('div');
                notification.className = 'fixed top-4 right-4 bg-blue-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 transition-opacity duration-300';
                notification.textContent = `å­—ä½“å·²åˆ‡æ¢ä¸º: ${this.fontSettings.family}`;
                
                document.body.appendChild(notification);
                
                // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
                setTimeout(() => {
                    notification.style.opacity = '0';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }, 2000);
            }
        }

        // åˆå§‹åŒ–åº”ç”¨
        const app = new WordPrintApp();
    </script>
</body>
</html>

